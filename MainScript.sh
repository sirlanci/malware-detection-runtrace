#!/bin/bash

DIR_exe="/home/username/vboxshare/exe" #The path of PE files located on host machine (Linux)

DIR_ReadOnly="/home/username/vboxshare/ReadOnly" #ReadOnly shared folder host path (Linux)
DIR_input="E:/" #ReadOnly shared folder VM path (Windows)

DIR_traceoutput="/home/username/vboxshare/trace_output" #Shared folder for run trace output VM path (Linux)
DIR_output="F:/" #Shared folder for run trace output VM path (Windows)

DIR_runtrace="/home/username/vboxshare/run_trace" #Run trace pool path on host machine (Linux)


for entry in "$DIR_exe"/* #Main loop to process all files in the exe folder
do
	#Preparation of files
	filename="${entry##*/}" #Get filename of current exe
	mv "$DIR_exe"/"$filename" "$DIR_ReadOnly"/"$filename" #Move current exe into ReadOnly Shared Folder
	./x64db_script_writer.sh #Run other bash script to generate x64dbg script for current executable in in ReadOnly folder
	
	#Starting the VM and debugging the exe
	vboxmanage snapshot "Cuckoo-Xp" restore "x64dbgfinal" #Restore the VM from snapshot
	vboxmanage startvm Cuckoo-Xp --type gui #start the VM
	sleep 2s #Wait for preparation of VM
	vboxmanage guestcontrol "Cuckoo-Xp" --username "Xp" run -- "C:/Documents and Settings/Xp/Desktop/snapshot_2020-04-12_19-58/release/x32/x32dbg.exe" "E:/$filename" #Run debugger with the current exe on VM
	sleep 2s 
	vboxmanage controlvm Cuckoo-Xp poweroff soft #Poweroff the VM
	sleep 2s
	
	#Moving output into run trace pool
	mv "$DIR_traceoutput"/"$filename"_trace.txt "$DIR_runtrace"/ #move run trace output text file from traceoutput folder to runtrace folder
	echo "Debug completed"

	#Remove exe and x64dbg script from ReadOnly folder
	rm "$DIR_ReadOnly"/"$filename"
	rm "$DIR_ReadOnly"/runtrace_script.txt

	read -p "Press Enter to move next exe" #Wait user input to continue with next exe
done