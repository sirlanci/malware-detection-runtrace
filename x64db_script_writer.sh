#!/bin/bash

DIR_in="/home/username/vboxshare/ReadOnly"
script_file="/home/username/vboxshare/ReadOnly/runtrace_script.txt"


#init_cmd='init E:\'
#sleep_cmd="zzz .2000"
cmp_cmd='cmp $pid,0' #Check wheather the exe is started correctly 
jmp_cmd='je end' #If pid=0, jump to the end of script
setlogfile_cmd='SetTraceLogFile F:\' #Set log file location (run trace output)
setlogformat_cmd='TraceSetLog {i:cip}, eip >= 00000000 && eip < 20000000' #Set the format of log file and restrict the address of instructions will be collected 
rtu_cmd="rtu" #move the instruction pointer to the beginning of user code with the Run To Usercode (rtu) command
stepinto_cmd="StepInto" #Sometimes the debugger do not start the next command (traceinto) without one stepinto command so it is used to make sure
traceinto_cmd="TraceIntoConditional 0,.10000000" #Start to execute instructions until the exe halts or the number of maximum instruction is reached
branch_cmd='end' #Put a branch to be able to jump at the end of script
i=1

for entry in  $DIR_in/* #This loop used to Take the only exe in ReadOnly folder and write a x64dbg script into a text file for the exe.
do
	filename=$(basename $entry) #Get filename of the exe
	#echo $init_cmd$filename >> $script_file
	#echo $sleep_cmd >> $script_file
	echo $cmp_cmd >> $script_file
	echo $jmp_cmd$i >> $script_file
	echo $rtu_cmd >> $script_file
	echo $rtu_cmd >> $script_file
	echo $sleep_cmd >> $script_file
	echo $stepinto_cmd >> $script_file
	echo $setlogfile_cmd$filename"_trace.txt" >> $script_file
	echo $setlogformat_cmd >> $script_file
	echo $traceinto_cmd >> $script_file
	echo $branch_cmd$i':' >>  $script_file
	echo "" >> $script_file
	((i++))
done